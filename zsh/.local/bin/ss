#!/usr/bin/env zsh

# tmux attach script: ta

SERVER_SESSION="server"

typeset -A START_DIRLIST=(
  [min]="$HOME/repos/minnesoda/min"
  [sun-app]="$HOME/sunnus/app/dev"
  [sun-srv]="$HOME/sunnus/cloud/functions"
)

typeset -A COMMANDS=(
  [min]="yarn dev"
  [sun-app]="yarn dev"
  [sun-srv]="yarn serve"
)

KEY=$(for i in ${(k)START_DIRLIST}; do
  echo $i
done | fzf $FZF_OPTS --header="Pick a repo to start a server from")

[[ -z $KEY ]] \
  && echo "No repo selected. Quitting." \
  && return 0

# results in c containing either $HOME or start dir
s=$START_DIRLIST[$KEY]
[ $s ] && START_DIR=$s || START_DIR=$HOME

# check for existence of SERVER_SESSION
! tmux has-session -t "$SERVER_SESSION" 2>/dev/null
session_exists=$?

# create it if it doesn't exist
create() { tmux new-session -d \
  -s $SERVER_SESSION -c $START_DIR -n $KEY \
  $COMMANDS[$KEY]
}
[[ $session_exists == 0 ]] && create

#!/usr/bin/env zsh

# tmux session manager:
#
# end game: use tmux as default terminal, but also have a base session.
# expected behavior:
# [base]
#   exit   -> exit and close terminal window
#          or reattach back to new base
#   detach -> detach without exiting and close terminal window
# [non-base]
#   exit   -> exit and reattach to base
#   detach -> detach without exiting attach to base

LOGFILE="$ZDOTDIR/tmux_session_log.txt"

log() {
  local timestamp=$(date '+%R:%S')
  echo "$timestamp: $@">>$LOGFILE
}

# always assume that thas script is ran from outside of tmux
if [ $TMUX ]; then
  log "already inside, quitting nested run."
  exit 0 # silently quit if already in tmux
fi


log "starting the loop"
while; do
  log "opened"
  RETURNCODE=$(exec tmux new-session -As base)
  log "exited: |$RETURNCODE|"
  [[ "$RETURNCODE" == "[detached (from session base)]" ]] && return 0
  [[ $RETURNCODE == "[exited]" ]] && continue
done

log "exited the loop"
